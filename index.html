<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Base</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .animate-bounce {
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-25%); animation-timing-function: cubic-bezier(0.8, 0, 1, 1); }
            50% { transform: none; animation-timing-function: cubic-bezier(0, 0, 0.2, 1); }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .bg-clip-text {
            -webkit-background-clip: text;
            background-clip: text;
        }
        .text-transparent {
            color: transparent;
        }
        /* Improved scrollbar styling */
        .workflow-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .workflow-container::-webkit-scrollbar {
            width: 8px;
        }
        .workflow-container::-webkit-scrollbar-track {
            background: rgba(147, 51, 234, 0.1);
            border-radius: 10px;
        }
        .workflow-container::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.3);
            border-radius: 10px;
        }
        .workflow-container::-webkit-scrollbar-thumb:hover {
            background: rgba(147, 51, 234, 0.5);
        }
    </style>
</head>
<body>
    <div
        class="min-h-screen p-4"
        style="background: linear-gradient(135deg, rgba(221, 160, 221, 0.6), rgba(173, 216, 230, 0.5), rgba(255, 192, 203, 0.4), rgba(186, 164, 235, 0.5));"
    >
        <!-- Floating celestial elements -->
        <div class="hidden sm:block absolute top-4 left-4 text-pink-300 animate-bounce text-2xl" style="animation-delay: 0s;">‚òÅÔ∏è</div>
        <div class="hidden sm:block absolute top-8 right-8 text-sky-300 animate-bounce text-xl" style="animation-delay: 1s;">ü´ß</div>
        <div class="hidden sm:block absolute top-16 left-16 text-pink-200 animate-bounce text-lg" style="animation-delay: 2s;">‚ú®</div>
        <div class="hidden sm:block absolute top-32 right-32 text-purple-300 animate-bounce text-xl" style="animation-delay: 1.5s;">üîÆ</div>

        <div class="max-w-2xl mx-auto pt-8">
            <div class="bg-gradient-to-br from-purple-100/90 to-pink-100/90 backdrop-blur-lg rounded-3xl shadow-2xl border-2 border-purple-200 p-4 sm:p-6 relative overflow-hidden">
                <!-- Dreamy corner elements -->
                <div class="absolute top-2 left-2 text-purple-400 text-xl sm:text-2xl">üîÆ</div>
                <div class="absolute top-2 right-2 text-sky-400 text-xl sm:text-2xl">‚òÅÔ∏è</div>

                <!-- Header with celestial styling -->
                <div class="text-center mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-purple-600 via-pink-600 to-indigo-600 bg-clip-text text-transparent mb-2">
                        ‚òÅÔ∏è Knowledge Base ‚òÅÔ∏è
                    </h1>
                    <div class="flex justify-center gap-2 text-xl sm:text-2xl">
                        <span class="animate-pulse">üåô</span>
                        <span class="animate-pulse" style="animation-delay: 0.5s;">‚ú®</span>
                        <span class="animate-pulse" style="animation-delay: 1s;">üí´</span>
                    </div>
                    <p class="text-xs text-purple-600 mt-2 font-medium">üåå Document your processes and procedures</p>
                </div>

                <!-- Add new workflow with cloud theme -->
                <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-2xl p-3 sm:p-4 mb-6 border-2 border-purple-200">
                    <div class="flex gap-2 sm:gap-3 items-center mb-3">
                        <span class="text-xl sm:text-2xl">ü´ß</span>
                        <input
                            type="text"
                            id="newWorkflow"
                            placeholder="Add new workflow..."
                            class="flex-1 px-3 sm:px-4 py-2 sm:py-3 bg-white/80 border-2 border-purple-200 rounded-full focus:outline-none focus:ring-4 focus:ring-pink-200 focus:border-purple-300 transition-all text-purple-800 placeholder-purple-400"
                        />
                        <button
                            id="addWorkflowBtn"
                            class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full hover:from-purple-600 hover:to-pink-600 focus:outline-none focus:ring-4 focus:ring-purple-200 transition-all transform hover:scale-105 shadow-lg"
                        >
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Filter buttons with dreamy cloud theme -->
                <div class="flex gap-2 mb-6 justify-center flex-wrap" id="filterButtons">
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="all">
                        <span class="text-lg">üí´</span>
                        <span class="text-xs font-medium">All (<span id="allCount">0</span>)</span>
                    </button>
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="critical">
                        <span class="text-lg">‚ú®</span>
                        <span class="text-xs font-medium">Critical (<span id="criticalCount">0</span>)</span>
                    </button>
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="coding">
                        <span class="text-lg">üåå</span>
                        <span class="text-xs font-medium">Coding (<span id="codingCount">0</span>)</span>
                    </button>
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="deployment">
                        <span class="text-lg">ü™ê</span>
                        <span class="text-xs font-medium">Deploy (<span id="deploymentCount">0</span>)</span>
                    </button>
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="content">
                        <span class="text-lg">üåô</span>
                        <span class="text-xs font-medium">Content (<span id="contentCount">0</span>)</span>
                    </button>
                    <button class="filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1" data-filter="research">
                        <span class="text-lg">üîÆ</span>
                        <span class="text-xs font-medium">Research (<span id="researchCount">0</span>)</span>
                    </button>
                </div>

                <!-- Workflow list -->
                <div class="workflow-container space-y-3 mb-6" id="workflowsList">
                    <!-- Content will be dynamically inserted here -->
                </div>

                <!-- Bottom celestial decorations -->
                <div class="absolute bottom-2 left-4 text-sky-300 text-lg">ü´ß</div>
                <div class="absolute bottom-2 right-4 text-pink-300 text-lg">‚ú®</div>
            </div>

            <!-- More floating celestial decorations -->
            <div class="hidden sm:block absolute bottom-8 left-8 text-pink-300 animate-bounce text-xl" style="animation-delay: 1.5s;">üåô</div>
            <div class="hidden sm:block absolute bottom-12 right-12 text-purple-300 animate-bounce text-lg" style="animation-delay: 0.5s;">ü™ê</div>
            <div class="hidden sm:block absolute bottom-20 left-20 text-sky-300 animate-bounce text-2xl" style="animation-delay: 2.5s;">‚òÅÔ∏è</div>
        </div>
    </div>

    <script>
        // Global state
        let workflows = [
            {
                id: 1,
                title: "Deploy to Production",
                category: "deployment",
                critical: true,
                trigger: "When code has been reviewed, tested, and approved for release",
                steps: [
                    { id: 1, description: "Run test suite locally", notes: "npm test", completed: false },
                    { id: 2, description: "Create pull request", notes: "Include deployment checklist", completed: false },
                    { id: 3, description: "Wait for code review approval", notes: "", completed: false },
                    { id: 4, description: "Deploy to staging", notes: "Test all critical paths", completed: false },
                    { id: 5, description: "Deploy to production", notes: "Monitor for 15 minutes after", completed: false }
                ],
            },
            {
                id: 2,
                title: "Historical Document Analysis",
                category: "research",
                critical: false,
                trigger: "When analyzing primary historical sources for authenticity and context",
                steps: [
                    { id: 1, description: "Identify primary source materials", notes: "Archives, manuscripts, contemporary accounts", completed: false },
                    { id: 2, description: "Verify document authenticity and provenance", notes: "Cross-reference with known collections", completed: false },
                    { id: 3, description: "Contextualize within historical period", notes: "Political, social, economic factors", completed: false },
                    { id: 4, description: "Cross-reference with secondary sources", notes: "Academic papers, other historians' work", completed: false }
                ],
            },
        ];

        let currentFilter = 'all';
        let expandedWorkflows = new Set([1]);

        // Utility functions
        function generateId() {
            return Date.now() + Math.random();
        }

        function updateCounts() {
            document.getElementById('allCount').textContent = workflows.length;
            document.getElementById('criticalCount').textContent = workflows.filter(w => w.critical).length;
            document.getElementById('codingCount').textContent = workflows.filter(w => w.category === 'coding').length;
            document.getElementById('deploymentCount').textContent = workflows.filter(w => w.category === 'deployment').length;
            document.getElementById('contentCount').textContent = workflows.filter(w => w.category === 'content').length;
            document.getElementById('researchCount').textContent = workflows.filter(w => w.category === 'research').length;
        }

        function updateFilterButtons() {
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                const filter = btn.dataset.filter;
                btn.className = `filter-btn px-3 py-2 rounded-lg transition-all transform hover:scale-105 flex flex-col items-center gap-1 ${
                    currentFilter === filter
                        ? getActiveFilterClass(filter)
                        : "bg-purple-50/80 text-purple-700 hover:bg-purple-100 border-2 border-transparent"
                }`;
            });
        }

        function getActiveFilterClass(filter) {
            const classes = {
                all: "bg-gradient-to-r from-purple-300 to-sky-300 text-white shadow-lg border-2 border-purple-400",
                critical: "bg-gradient-to-r from-pink-300 to-purple-300 text-white shadow-lg border-2 border-pink-400",
                coding: "bg-gradient-to-r from-sky-300 to-purple-300 text-white shadow-lg border-2 border-sky-400",
                deployment: "bg-gradient-to-r from-purple-300 to-pink-300 text-white shadow-lg border-2 border-purple-400",
                content: "bg-gradient-to-r from-pink-300 to-sky-300 text-white shadow-lg border-2 border-pink-400",
                research: "bg-gradient-to-r from-purple-300 to-indigo-300 text-white shadow-lg border-2 border-purple-400"
            };
            return classes[filter] || classes.all;
        }

        function getWorkflowCardClass(workflow) {
            if (workflow.critical) {
                return "bg-gradient-to-r from-purple-50/90 to-indigo-50/90 border-2 border-purple-300 shadow-md hover:shadow-lg backdrop-blur-sm";
            } else if (workflow.category === "deployment") {
                return "bg-gradient-to-r from-blue-50/90 to-slate-50/90 border-2 border-blue-300 shadow-md hover:shadow-lg backdrop-blur-sm";
            } else if (workflow.category === "coding") {
                return "bg-gradient-to-r from-indigo-50/90 to-blue-50/90 border-2 border-indigo-300 shadow-md hover:shadow-lg backdrop-blur-sm";
            } else {
                return "bg-gradient-to-r from-slate-50/90 to-blue-50/90 border-2 border-slate-300 shadow-md hover:shadow-lg backdrop-blur-sm";
            }
        }

        function filterWorkflows() {
            return workflows.filter(workflow => {
                if (currentFilter === "critical") return workflow.critical;
                if (currentFilter === "coding") return workflow.category === "coding";
                if (currentFilter === "deployment") return workflow.category === "deployment";
                if (currentFilter === "content") return workflow.category === "content";
                if (currentFilter === "research") return workflow.category === "research";
                return true;
            });
        }

        function createWorkflowElement(workflow) {
            const isExpanded = expandedWorkflows.has(workflow.id);
            const completedSteps = workflow.steps.filter(s => s.completed).length;
            
            return `
                <div class="space-y-0">
                    <div class="group p-3 sm:p-4 rounded-2xl transition-all transform hover:scale-[1.02] relative ${getWorkflowCardClass(workflow)}">
                        ${workflow.critical ? `
                            <div class="absolute -top-2 -right-2 bg-gradient-to-r from-purple-400 to-pink-400 text-white text-xs px-2 py-1 rounded-full shadow-lg flex items-center gap-1">
                                <span>‚ú®</span>
                                <span class="font-medium">CRITICAL</span>
                            </div>
                        ` : ''}
                        
                        <div class="mb-3 flex justify-center gap-2">
                            <button
                                onclick="toggleCritical(${workflow.id})"
                                class="w-8 h-8 rounded-full transition-all transform hover:scale-110 flex items-center justify-center ${
                                    workflow.critical
                                        ? "bg-gradient-to-r from-purple-400 to-pink-400 text-white shadow-lg"
                                        : "bg-purple-100 hover:bg-sky-100 text-purple-500 hover:text-sky-600"
                                }"
                                title="${workflow.critical ? 'Remove critical flag' : 'Mark as critical'}"
                            >
                                <span class="text-sm">‚ú®</span>
                            </button>
                            <select
                                onchange="setCategory(${workflow.id}, this.value)"
                                class="px-2 py-1 text-xs border border-sky-300 rounded-full bg-white/90 focus:outline-none focus:ring-2 focus:ring-sky-300 text-purple-700"
                            >
                                <option value="coding" ${workflow.category === 'coding' ? 'selected' : ''}>üåå Coding</option>
                                <option value="deployment" ${workflow.category === 'deployment' ? 'selected' : ''}>ü™ê Deploy</option>
                                <option value="content" ${workflow.category === 'content' ? 'selected' : ''}>üåô Content</option>
                                <option value="research" ${workflow.category === 'research' ? 'selected' : ''}>üîÆ Research</option>
                            </select>
                        </div>

                        <div class="flex items-center justify-between">
                            <h3
                                class="text-base sm:text-lg font-semibold text-purple-900 cursor-pointer flex-1"
                                onclick="toggleExpanded(${workflow.id})"
                            >
                                ${workflow.title}
                            </h3>
                            
                            <div class="flex items-center gap-2">
                                ${workflow.steps.length > 0 ? `
                                    <span class="text-sm text-purple-600 font-medium">
                                        ${completedSteps}/${workflow.steps.length}
                                    </span>
                                ` : ''}
                                <button
                                    onclick="toggleExpanded(${workflow.id})"
                                    class="w-6 h-6 rounded-full bg-white/90 hover:bg-sky-100 text-purple-700 transition-all transform hover:scale-110 flex items-center justify-center"
                                >
                                    <span class="text-xs transition-transform ${isExpanded ? 'rotate-90' : ''}">‚ñ∂</span>
                                </button>
                                <button
                                    onclick="resetWorkflow(${workflow.id})"
                                    class="w-7 h-7 rounded-full bg-sky-100 hover:bg-sky-200 text-sky-600 hover:text-sky-700 transition-all transform hover:scale-110 flex items-center justify-center opacity-0 group-hover:opacity-100"
                                    title="Reset workflow"
                                >
                                    <span class="text-sm">‚Ü∫</span>
                                </button>
                                <button
                                    onclick="deleteWorkflow(${workflow.id})"
                                    class="w-7 h-7 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-600 hover:text-purple-700 transition-all transform hover:scale-110 flex items-center justify-center opacity-0 group-hover:opacity-100"
                                >
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    ${isExpanded ? `
                        <div class="mt-0 ml-4 sm:ml-8 mr-2 sm:mr-4 mb-4 space-y-3 bg-gradient-to-r from-purple-50/80 to-pink-50/80 p-3 sm:p-4 rounded-xl border border-purple-300 backdrop-blur-sm">
                            <div class="bg-white/80 p-3 rounded-lg border border-purple-200">
                                <label class="block text-sm font-medium text-purple-800 mb-2">
                                    ‚ö° When to use this workflow:
                                </label>
                                <textarea
                                    onchange="updateTrigger(${workflow.id}, this.value)"
                                    placeholder="Describe what situations or conditions trigger this workflow..."
                                    class="w-full px-3 py-2 bg-white/90 border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-300 focus:border-purple-400 transition-all text-sm text-purple-800 resize-none placeholder-purple-400"
                                    rows="2"
                                >${workflow.trigger || ''}</textarea>
                            </div>

                            <div class="flex gap-2 items-center">
                                <span class="text-sm">ü´ß</span>
                                <input
                                    type="text"
                                    id="newStep-${workflow.id}"
                                    placeholder="Add a step..."
                                    class="flex-1 px-3 py-2 bg-white/80 border border-purple-300 rounded-full focus:outline-none focus:ring-2 focus:ring-pink-300 focus:border-purple-400 transition-all text-sm text-purple-800 placeholder-purple-400"
                                    onkeypress="if(event.key==='Enter') addStep(${workflow.id})"
                                />
                                <button
                                    onclick="addStep(${workflow.id})"
                                    class="px-3 py-2 bg-gradient-to-r from-purple-400 to-pink-400 text-white rounded-full hover:from-purple-500 hover:to-pink-500 transition-all transform hover:scale-105 shadow-sm"
                                >
                                    <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-2">
                                ${workflow.steps.map((step, index) => `
                                    <div class="flex items-start gap-2 sm:gap-3 p-2 sm:p-3 rounded-xl border ${
                                        step.completed 
                                            ? "bg-gradient-to-r from-green-100/80 to-emerald-100/80 border-green-300 backdrop-blur-sm" 
                                            : "bg-purple-50/90 border-purple-300 backdrop-blur-sm"
                                    }">
                                        <button
                                            onclick="toggleStep(${workflow.id}, ${step.id})"
                                            class="mt-1 w-6 h-6 rounded-full flex items-center justify-center transition-all transform hover:scale-110 ${
                                                step.completed
                                                    ? "bg-gradient-to-r from-green-300 to-emerald-300 shadow-sm"
                                                    : "bg-gradient-to-r from-purple-100 to-sky-100 hover:from-purple-200 hover:to-sky-200 border border-purple-300"
                                            }"
                                        >
                                            ${step.completed 
                                                ? '<span class="text-white text-xs">‚úì</span>' 
                                                : '<span class="text-xs">‚òÅÔ∏è</span>'
                                            }
                                        </button>
                                        
                                        <div class="flex-1">
                                            <div class="flex items-start justify-between">
                                                <span class="font-medium transition-all text-sm sm:text-base ${
                                                    step.completed
                                                        ? "text-green-700 line-through opacity-75"
                                                        : "text-purple-800"
                                                }">
                                                    ${index + 1}. ${step.description}
                                                </span>
                                                <button
                                                    onclick="deleteStep(${workflow.id}, ${step.id})"
                                                    class="w-5 h-5 rounded-full bg-purple-100 hover:bg-purple-200 text-purple-500 hover:text-purple-600 transition-all transform hover:scale-110 flex items-center justify-center ml-2"
                                                >
                                                    <svg width="10" height="10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <input
                                                type="text"
                                                value="${step.notes || ''}"
                                                onchange="updateStepNotes(${workflow.id}, ${step.id}, this.value)"
                                                placeholder="Add notes..."
                                                class="text-xs sm:text-sm text-purple-700 mt-1 w-full bg-transparent border-b border-purple-200 focus:border-purple-400 focus:outline-none placeholder-purple-300"
                                            />
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function render() {
            const filteredWorkflows = filterWorkflows();
            const workflowsList = document.getElementById('workflowsList');

            if (filteredWorkflows.length === 0) {
                workflowsList.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">‚òÅÔ∏è</div>
                        <p class="text-purple-600 font-medium">
                            ${currentFilter === 'all' 
                                ? 'No workflows yet. Add one above!' 
                                : `No ${currentFilter} workflows found.`}
                        </p>
                    </div>
                `;
            } else {
                workflowsList.innerHTML = filteredWorkflows.map(createWorkflowElement).join('');
            }

            updateCounts();
            updateFilterButtons();
        }

        // Workflow management functions
        function addWorkflow() {
            const input = document.getElementById('newWorkflow');
            const title = input.value.trim();
            
            if (title) {
                const newWorkflow = {
                    id: generateId(),
                    title: title,
                    category: "coding",
                    critical: false,
                    trigger: "",
                    steps: [],
                };
                workflows.unshift(newWorkflow);
                expandedWorkflows.add(newWorkflow.id);
                input.value = '';
                render();
            }
        }

        function deleteWorkflow(id) {
            if (confirm('Are you sure you want to delete this workflow?')) {
                workflows = workflows.filter(w => w.id !== id);
                expandedWorkflows.delete(id);
                render();
            }
        }

        function toggleCritical(id) {
            workflows = workflows.map(w => 
                w.id === id ? { ...w, critical: !w.critical } : w
            );
            render();
        }

        function setCategory(id, category) {
            workflows = workflows.map(w => 
                w.id === id ? { ...w, category } : w
            );
            render();
        }

        function updateTrigger(id, trigger) {
            workflows = workflows.map(w => 
                w.id === id ? { ...w, trigger } : w
            );
        }

        function toggleExpanded(id) {
            if (expandedWorkflows.has(id)) {
                expandedWorkflows.delete(id);
            } else {
                expandedWorkflows.add(id);
            }
            render();
        }

        function resetWorkflow(id) {
            if (confirm('Reset all steps in this workflow?')) {
                workflows = workflows.map(w =>
                    w.id === id
                        ? { ...w, steps: w.steps.map(s => ({ ...s, completed: false })) }
                        : w
                );
                render();
            }
        }

        function addStep(workflowId) {
            const input = document.getElementById(`newStep-${workflowId}`);
            const description = input.value.trim();
            
            if (description) {
                workflows = workflows.map(w => {
                    if (w.id === workflowId) {
                        return {
                            ...w,
                            steps: [...w.steps, {
                                id: generateId(),
                                description: description,
                                notes: "",
                                completed: false,
                            }]
                        };
                    }
                    return w;
                });
                render();
            }
        }

        function deleteStep(workflowId, stepId) {
            workflows = workflows.map(w => {
                if (w.id === workflowId) {
                    return {
                        ...w,
                        steps: w.steps.filter(s => s.id !== stepId)
                    };
                }
                return w;
            });
            render();
        }

        function toggleStep(workflowId, stepId) {
            workflows = workflows.map(w => {
                if (w.id === workflowId) {
                    return {
                        ...w,
                        steps: w.steps.map(s =>
                            s.id === stepId ? { ...s, completed: !s.completed } : s
                        )
                    };
                }
                return w;
            });
            render();
        }

        function updateStepNotes(workflowId, stepId, notes) {
            workflows = workflows.map(w => {
                if (w.id === workflowId) {
                    return {
                        ...w,
                        steps: w.steps.map(s =>
                            s.id === stepId ? { ...s, notes } : s
                        )
                    };
                }
                return w;
            });
            // Don't re-render to avoid losing focus on the input
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add workflow button
            document.getElementById('addWorkflowBtn').addEventListener('click', addWorkflow);
            
            // Enter key on new workflow input
            document.getElementById('newWorkflow').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addWorkflow();
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentFilter = this.dataset.filter;
                    render();
                });
            });

            // Load from localStorage if available
            const saved = localStorage.getItem('workflows');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (parsed.workflows) workflows = parsed.workflows;
                    if (parsed.expandedWorkflows) expandedWorkflows = new Set(parsed.expandedWorkflows);
                } catch (e) {
                    console.error('Error loading saved workflows:', e);
                }
            }

            // Save to localStorage on changes
            window.addEventListener('beforeunload', function() {
                localStorage.setItem('workflows', JSON.stringify({
                    workflows: workflows,
                    expandedWorkflows: Array.from(expandedWorkflows)
                }));
            });

            // Initial render
            render();
        });

        // Auto-save every 30 seconds
        setInterval(function() {
            localStorage.setItem('workflows', JSON.stringify({
                workflows: workflows,
                expandedWorkflows: Array.from(expandedWorkflows)
            }));
        }, 30000);
    </script>
</body>
</html>
